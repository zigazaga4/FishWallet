events {}
http {
  upstream app { server 127.0.0.1:3000; }
  gzip off;

  server {
    listen 8080;

    # Header-based with version: /v1|v2/{rest} (MUST COME BEFORE LEGACY)
    location ~ ^/v(?:1|2)/(.*)$ {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      rewrite ^/v(?:1|2)/(.*)$ /$1 break;
      proxy_pass http://app;
    }

    # Legacy with API key and version: /{apiKey}/v1|v2/{rest}
    location ~ ^/(?<apikey>[^/]+)/v(?:1|2)/(.*)$ {
      proxy_set_header X-Firecrawl-API-Key $apikey;
      proxy_set_header Host $host;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      rewrite ^/[^/]+/v(?:1|2)/(.*)$ /$1 break;
      proxy_pass http://app;
    }

    # Legacy: /{apiKey}/{rest}
    location ~ ^/(?<apikey>[^/]+)/(.*)$ {
      proxy_set_header X-Firecrawl-API-Key $apikey;
      proxy_set_header Host $host;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      rewrite ^/[^/]+/(.*)$ /$1 break;
      proxy_pass http://app;
    }

    # Direct header-based paths
    location /mcp {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_pass http://app/mcp;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /messages {
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;
      chunked_transfer_encoding off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/messages;
    }

    location /sse {
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;
      chunked_transfer_encoding off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Connection "";
      proxy_set_header Accept "text/event-stream";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/sse;
    }

    location /health {
      proxy_buffering off;
      proxy_read_timeout 5s;
      proxy_send_timeout 5s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/health;
    }

    location / {
      return 301 https://docs.firecrawl.dev/mcp-server;
    }
  }
}